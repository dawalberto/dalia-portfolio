---
import type { IconName } from "@/components/Icon.astro"
import Layout from "./Layout.astro"
import Icon from "@/components/Icon.astro"

type ProjectProps = {
  title: string
  titleIcon: IconName
  rol: string
  duration: string
  typeOfProject: string
  tools: string[]
  navItems: Map<string, { title: string; icon: IconName }>
}

const { title, titleIcon, rol, duration, typeOfProject, tools, navItems } =
  Astro.props as ProjectProps
---

<Layout>
  <article>
    <header class="flex flex-col font-roboto text-4xl">
      <h1 class="flex gap-4 4k:-ml-12 items-center mt-16 pb-6 font-bold">
        <span><Icon icon={titleIcon} /></span>
        <span>{title}</span>
      </h1>
      <div
        project-info
        class="flex flex-col text-main-0 visible text-xl max-h-52 transform transition-all duration-300 ease-in-out"
      >
        <h2><span class="font-bold">Rol:</span> <span class="opacity-85">{rol}</span></h2>
        <h2>
          <span class="font-bold">Duraci√≥n:</span>
          <span class="opacity-85">{duration}</span>
        </h2>
        <h2>
          <span class="font-bold">Tipo de proyecto:</span>
          <span class="opacity-85">{typeOfProject}</span>
        </h2>
        <h2>
          <span class="font-bold">Herramientas:</span>
          <span class="opacity-85">{tools?.join(", ")}</span>
        </h2>
      </div>
    </header>
    <aside
      project-aside
      class="font-roboto text-base mt-16 transform transition-all duration-300 ease-in-out"
    >
      <nav class="px-4 py-2">
        <ul class="flex flex-col gap-y-4">
          {
            navItems &&
              Array.from(navItems.entries()).map(([key, item]) => (
                <li class="group">
                  <a
                    href={`#${key}`}
                    class="flex gap-2 items-center opacity-40 group-hover:opacity-100 group-hover:font-bold"
                  >
                    <span class="flex-none">
                      <Icon icon={item.icon} />
                    </span>
                    {item.title}
                  </a>
                </li>
              ))
          }
        </ul>
      </nav>
    </aside>
    <main
      project-content
      class="project-content mt-16 transform transition-all duration-300 ease-in-out"
    >
      <slot />
    </main>
  </article>
</Layout>

<script>
  const projectContentContainer = document.querySelector("[project-content]") as HTMLElement | null
  const projectInfoContainer = document.querySelector("[project-info]") as HTMLElement | null
  const projectAsideContainer = document.querySelector("[project-aside]") as HTMLElement | null

  projectContentContainer?.addEventListener("scroll", () => {
    if (!projectContentContainer || !projectInfoContainer || !projectAsideContainer) return
    const { scrollTop } = projectContentContainer

    if (scrollTop > 125) {
      projectInfoContainer.classList.replace("max-h-52", "max-h-0")
      projectInfoContainer.classList.replace("text-main-0", "text-white")
      projectInfoContainer.classList.replace("visible", "invisible")
      projectContentContainer.classList.replace("mt-16", "mt-0")
      projectAsideContainer.classList.replace("mt-16", "mt-0")
    } else {
      projectInfoContainer.classList.replace("max-h-0", "max-h-52")
      projectInfoContainer.classList.replace("text-white", "text-main-0")
      projectInfoContainer.classList.replace("invisible", "visible")
      projectContentContainer.classList.replace("mt-0", "mt-16")
      projectAsideContainer.classList.replace("mt-0", "mt-16")
    }
  })

  // Active navItem üëá
  const sections = document.querySelectorAll("main[project-content] section[id]")
  const navLinks = document.querySelectorAll("aside[project-aside] nav a")

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // Quitamos "active" de todos
          navLinks.forEach((link) => link.classList.remove("active"))
          // Buscamos el link que apunta a la secci√≥n visible
          const id = entry.target.getAttribute("id")
          const activeLink = document.querySelector(`aside[project-aside] nav a[href="#${id}"]`)
          if (activeLink) activeLink.classList.add("active")
        }
      })
    },
    {
      root: document.querySelector("main[project-content]"), // scroll container
      threshold: 0.6, // 60% de visibilidad
    }
  )

  sections.forEach((section) => observer.observe(section))
</script>

<style>
  @reference '../styles/global.css';

  article {
    margin: 0;
    height: var(--spacing-full-without-menu); /* Toda la ventana */
    display: grid;
    grid-template-rows: auto 1fr;
    grid-template-columns: 200px 1fr; /* Sidebar 200px + body resto */
    grid-template-areas:
      "header header"
      "sidebar body";
  }

  header {
    grid-area: header;
  }

  aside {
    grid-area: sidebar;
    overflow-y: auto; /* Scroll independiente */
  }

  main {
    grid-area: body;
    overflow-y: auto; /* Scroll independiente */
    scroll-behavior: smooth;
    padding-inline: min(20em, 10%);
  }

  :global(section) {
    scroll-margin-top: 0; /* Ajusta este valor para que coincida con el offset del scroll */
  }

  :global(nav a.active) {
    opacity: 1;
    font-weight: bold;
  }

  :global(main.project-content > div) {
    @apply flex flex-col gap-20 text-xl font-roboto text-pretty text-main-0 leading-7;
  }

  :global(main.project-content section) {
    @apply flex flex-col gap-6;
  }

  :global(main.project-content section h2) {
    @apply flex items-center gap-1.5 text-3xl font-bold;
  }

  :global(main.project-content section h3) {
    @apply flex items-center gap-1.5 text-2xl font-bold;
  }

  :global(main.project-content section ul) {
    @apply list-disc list-outside ml-6;
  }
</style>
