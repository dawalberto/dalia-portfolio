---
import type { IconName } from "@/components/Icon.astro"
import Layout from "./Layout.astro"
import Icon from "@/components/Icon.astro"
import { slide } from "astro:transitions"

type ProjectProps = {
  title: string
  rol: string
  duration: string
  typeOfProject: string
  tools: string[]
  link?: string
  navItems: Map<string, { title: string; icon: IconName }>
}

const { title, rol, duration, typeOfProject, tools, link, navItems } = Astro.props as ProjectProps
---

<Layout>
  <article>
    <header
      project-header
      class="flex flex-col font-roboto text-3xl sm:text-4xl sm:mt-8 border-b border-[#cccccc] pb-2 sm:pb-8"
    >
      <h1
        transition:animate={slide({
          duration: 300,
        })}
        class="flex gap-4 items-center pb-6 font-bold font-playfair text-main-0 text-pretty"
      >
        <span>{title}</span>
      </h1>
      <div
        project-info
        class="flex flex-col gap-y-2 text-main-0 visible text-base sm:text-xl max-h-52 transform transition-all duration-300 ease-in-out"
      >
        <h2><span class="font-bold">Rol:</span> <span class="opacity-85">{rol}</span></h2>
        <h2>
          <span class="font-bold">Duración:</span>
          <span class="opacity-85">{duration}</span>
        </h2>
        <h2>
          <span class="font-bold">Tipo de proyecto:</span>
          <span class="opacity-85">{typeOfProject}</span>
        </h2>
        <h2>
          <span class="font-bold">Herramientas:</span>
          <span class="opacity-85">{tools?.join(", ")}</span>
        </h2>
        {
          link && (
            <h2 class="flex gap-2 items-center w-fit group">
              <span class="group-hover:rotate-180 transform transition-transform duration-300 ease-in-out">
                <Icon icon="link" />
              </span>
              <a
                class="opacity-85 group-hover:underline text-main-17"
                href={`https://${link}`}
                target="_blank"
              >
                {link}
              </a>
            </h2>
          )
        }
      </div>
    </header>
    <aside
      project-aside
      class="font-roboto text-base mt-8 transform transition-all duration-300 ease-in-out"
    >
      <nav class="py-2">
        <ul class="flex flex-col gap-y-1">
          {
            navItems &&
              Array.from(navItems.entries()).map(([key, item]) => (
                <li class="group hover:bg-[#F1F1F1] leading-6 py-3 px-2 rounded-md transform transition duration-200">
                  <a
                    href={`#${key}`}
                    class="flex gap-2 items-start opacity-40 group-hover:opacity-100 group-hover:font-bold"
                  >
                    <span class="flex-none pt-1">
                      <Icon icon={item.icon} />
                    </span>
                    {item.title}
                  </a>
                </li>
              ))
          }
        </ul>
      </nav>
    </aside>
    <main
      project-content
      class="project-content mt-8 pt-4 transform transition-all duration-300 ease-in-out"
    >
      <slot />
    </main>
  </article>
</Layout>

<script>
  // Variables globales para manejar observadores
  let currentScrollObserver: (() => void) | null = null
  let currentIntersectionObserver: IntersectionObserver | null = null
  let isScrolling = false
  let scrollTimeout: NodeJS.Timeout

  document.addEventListener("astro:after-swap", () => {
    initProjectLayout()
  })

  function initProjectLayout() {
    // Limpiar observadores previos
    cleanup()

    const projectContentContainer = document.querySelector(
      "[project-content]"
    ) as HTMLElement | null

    if (!projectContentContainer) return

    // Configurar observador de scroll para el header
    setupScrollObserver(projectContentContainer)

    // Configurar observador de intersección para navegación
    setupNavigationObserver(projectContentContainer)
  }

  function cleanup() {
    // Remover listener de scroll previo
    if (currentScrollObserver) {
      const container = document.querySelector("[project-content]")
      container?.removeEventListener("scroll", currentScrollObserver)
      currentScrollObserver = null
    }

    // Desconectar observador de intersección previo
    if (currentIntersectionObserver) {
      currentIntersectionObserver.disconnect()
      currentIntersectionObserver = null
    }
  }

  function setupScrollObserver(container: HTMLElement) {
    const projectInfoContainer = document.querySelector("[project-info]") as HTMLElement | null
    const projectAsideContainer = document.querySelector("[project-aside]") as HTMLElement | null
    const projectHeaderContainer = document.querySelector("[project-header]") as HTMLElement | null

    if (!projectInfoContainer || !projectAsideContainer || !projectHeaderContainer) return

    const scrollHandler = () => {
      const { scrollTop } = container

      if (scrollTop > 125) {
        projectInfoContainer.classList.replace("max-h-52", "max-h-0")
        projectInfoContainer.classList.replace("text-main-0", "text-white")
        projectInfoContainer.classList.replace("visible", "invisible")
        container.classList.replace("mt-8", "mt-0")
        projectAsideContainer.classList.replace("mt-8", "mt-0")
        projectHeaderContainer.classList.replace("pb-2", "pb-0")
        projectHeaderContainer.classList.replace("text-3xl", "text-xl")
        projectHeaderContainer.classList.replace("sm:mt-8", "sm:mt-4")
        projectHeaderContainer.classList.replace("sm:pb-8", "sm:pb-4")
        projectHeaderContainer.querySelector("h1")?.classList.replace("pb-6", "pb-2")
      } else {
        projectInfoContainer.classList.replace("max-h-0", "max-h-52")
        projectInfoContainer.classList.replace("text-white", "text-main-0")
        projectInfoContainer.classList.replace("invisible", "visible")
        container.classList.replace("mt-0", "mt-8")
        projectAsideContainer.classList.replace("mt-0", "mt-8")
        projectHeaderContainer.classList.replace("pb-0", "pb-2")
        projectHeaderContainer.classList.replace("text-xl", "text-3xl")
        projectHeaderContainer.classList.replace("sm:mt-4", "sm:mt-8")
        projectHeaderContainer.classList.replace("sm:pb-4", "sm:pb-8")
        projectHeaderContainer.querySelector("h1")?.classList.replace("pb-2", "pb-6")
      }
    }

    currentScrollObserver = scrollHandler
    container.addEventListener("scroll", scrollHandler, { passive: true })
  }

  function setupNavigationObserver(container: HTMLElement) {
    const sections = document.querySelectorAll("main[project-content] section[id]")
    const navLinks = document.querySelectorAll("aside[project-aside] nav a")

    if (sections.length === 0 || navLinks.length === 0) return

    // Función para actualizar navegación activa
    function updateActiveNav(activeId: string) {
      navLinks.forEach((link) => {
        link.classList.remove("active")
        if (link.getAttribute("href") === `#${activeId}`) {
          link.classList.add("active")
        }
      })
    }

    // Función para determinar qué sección está más visible
    function findMostVisibleSection() {
      let mostVisible = { element: null as Element | null, ratio: 0 }

      sections.forEach((section) => {
        const rect = section.getBoundingClientRect()
        const containerRect = container.getBoundingClientRect()

        // Calcular qué parte de la sección es visible
        const visibleTop = Math.max(rect.top, containerRect.top)
        const visibleBottom = Math.min(rect.bottom, containerRect.bottom)
        const visibleHeight = Math.max(0, visibleBottom - visibleTop)
        const visibilityRatio = visibleHeight / rect.height

        if (visibilityRatio > mostVisible.ratio) {
          mostVisible = { element: section, ratio: visibilityRatio }
        }
      })

      return mostVisible.element
    }

    // Observer con múltiples thresholds para mayor precisión
    const thresholds = Array.from({ length: 21 }, (_, i) => i * 0.05) // 0, 0.05, 0.1, ..., 1.0

    currentIntersectionObserver = new IntersectionObserver(
      (entries) => {
        // Evitar conflictos durante scroll programático
        if (isScrolling) return

        // Si alguna sección tiene alta visibilidad, úsala
        const highlyVisible = entries.find((entry) => entry.intersectionRatio > 0.5)
        if (highlyVisible?.isIntersecting) {
          const id = highlyVisible.target.getAttribute("id")
          if (id) updateActiveNav(id)
          return
        }

        // Si no, encontrar la más visible manualmente
        const mostVisible = findMostVisibleSection()
        if (mostVisible) {
          const id = mostVisible.getAttribute("id")
          if (id) updateActiveNav(id)
        }
      },
      {
        root: container,
        rootMargin: "-10% 0px -10% 0px", // Margen para activar antes
        threshold: thresholds,
      }
    )

    sections.forEach((section) => {
      currentIntersectionObserver?.observe(section)
    })

    // Manejar clicks en navegación
    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault()
        const href = link.getAttribute("href")
        if (!href) return

        const targetId = href.substring(1)
        const targetSection = document.getElementById(targetId)
        if (!targetSection) return

        // Marcar que estamos en scroll programático
        isScrolling = true
        clearTimeout(scrollTimeout)

        // Scroll suave al objetivo
        targetSection.scrollIntoView({
          behavior: "smooth",
          block: "start",
          inline: "nearest",
        })

        // Actualizar navegación inmediatamente
        updateActiveNav(targetId)

        // Restablecer flag después del scroll
        scrollTimeout = setTimeout(() => {
          isScrolling = false
        }, 1000) // Tiempo suficiente para completar scroll suave
      })
    })

    // Activar el primer elemento visible al cargar
    setTimeout(() => {
      const mostVisible = findMostVisibleSection()
      if (mostVisible) {
        const id = mostVisible.getAttribute("id")
        if (id) updateActiveNav(id)
      }
    }, 100)
  }

  // Inicialización al primer render
  initProjectLayout()

  // Limpiar al salir de la página
  document.addEventListener("astro:before-swap", cleanup)
</script>

<style>
  @reference '../styles/global.css';

  article {
    margin: 0;
    height: var(--spacing-full-without-menu-desktop);
    display: grid;
    grid-template-rows: auto 1fr;
    grid-template-columns: 200px 1fr;
    grid-template-areas:
      "header header"
      "sidebar body";
  }

  header {
    grid-area: header;
  }

  aside {
    grid-area: sidebar;
    overflow-y: auto;
  }

  main {
    grid-area: body;
    overflow-y: auto;
    scroll-behavior: smooth;
    padding-inline: min(16em, 6%);
  }

  :global(section) {
    scroll-margin-top: 20px; /* Mejor offset para navegación */
  }

  :global(nav a.active) {
    opacity: 1 !important;
    font-weight: bold !important;
    color: var(--color-main-17, #1f2937);
  }

  :global(main.project-content > div) {
    @apply flex flex-col gap-11 text-lg sm:text-xl font-roboto text-pretty text-main-0 leading-8;
  }

  :global(main.project-content section) {
    @apply flex flex-col gap-4 sm:gap-6;
    min-height: 100px; /* Altura mínima para mejor detección */
  }

  :global(main.project-content img) {
    @apply rounded-sm;
  }

  :global(main.project-content section strong) {
    @apply font-semibold;
  }

  :global(main.project-content section h2) {
    @apply flex items-center gap-1.5 text-xl sm:text-2xl font-bold;
  }

  :global(main.project-content section h2 svg) {
    @apply flex-none self-start mt-1;
  }

  :global(main.project-content section h3) {
    @apply flex items-center gap-1.5 text-lg sm:text-xl font-bold;
  }

  :global(main.project-content section p.confidence) {
    @apply text-xs;
  }

  :global(main.project-content section h3 svg) {
    @apply flex-none self-start mt-1;
  }

  :global(main.project-content section ul) {
    @apply list-disc list-outside ml-6;
  }

  :global(main.project-content section ul.custom-list) {
    @apply list-none;
  }

  :global(main.project-content section ul ul) {
    @apply py-3;
  }

  :global(main.project-content section ul p) {
    @apply py-3;
  }

  :global(main.project-content section ol) {
    @apply list-decimal list-outside ml-6;
  }

  @media (max-width: theme(screens.sm)) {
    article {
      height: var(--spacing-full-without-menu-mobile);
      grid-template-columns: 1fr;
      grid-template-areas:
        "header"
        "body";
    }

    aside[project-aside] {
      display: none;
    }

    main[project-content] {
      padding-inline: 0;
    }
  }
</style>
